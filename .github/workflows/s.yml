name: Send Lichess Messages from list.txt

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # â° runs every hour at minute 0

jobs:
  send_messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # ğŸ•’ Time check step â€” stop if before 18:30 IST 29 Oct 2025
      - name: Check time (cancel if before target)
        id: timecheck
        run: |
          export TZ='Asia/Kolkata'
          current_ist_epoch=$(date '+%s')
          target_ist_epoch=$(date -d '2025-10-29 18:30:00' '+%s')

          echo "ğŸ•’ Current IST: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ¯ Target IST : 2025-10-29 18:30:00 IST"

          if [ "$current_ist_epoch" -lt "$target_ist_epoch" ]; then
            remaining=$((target_ist_epoch - current_ist_epoch))
            hrs=$((remaining / 3600))
            mins=$(((remaining % 3600) / 60))
            echo "â³ Not yet 18:30 IST â€” about ${hrs}h ${mins}m left. Cancelling workflow."
            exit 78
          else
            echo "âœ… Target time reached, continuing..."
          fi

      # ğŸ“¤ Send messages once target time reached
      - name: Send messages from list.txt
        if: success()
        env:
          BR: ${{ secrets.REAL }}
        run: |
          if [ ! -f list.txt ]; then
            echo "âŒ list.txt not found!"
            exit 1
          fi

          while IFS= read -r username; do
            if [ -n "$username" ]; then
              echo "ğŸ“¨ Sending message to $username"
              python -u s.py "$username"
              echo "âœ… Done for $username"
              echo "----------------------------------------"
              sleep 3
            fi
          done < list.txt

      # ğŸš« Disable this workflow after run
      - name: Disable this workflow after run
        env:
          GH_TOKEN: ${{ secrets.GH }}
        run: |
          echo "ğŸ”’ Disabling workflow '${{ github.workflow }}'..."
          curl -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/disable
          echo "âœ… Workflow disabled successfully."
