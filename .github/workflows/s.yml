name: Send Lichess Messages from list.txt

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # ⏰ runs every hour at minute 0

jobs:
  send_messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # 🕒 Time check step — stop if before 18:30 IST today
      - name: Check time (cancel if before 18:30 IST)
        id: timecheck
        run: |
          export TZ='Asia/Kolkata'
          current_ist_epoch=$(date '+%s')

          # Get today's date and append 18:30:00
          target_ist_epoch=$(date -d "$(date +%Y-%m-%d) 18:30:00" '+%s')

          echo "🕒 Current IST: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "🎯 Target IST : $(date +%Y-%m-%d) 18:30:00 IST"

          if [ "$current_ist_epoch" -lt "$target_ist_epoch" ]; then
            remaining=$((target_ist_epoch - current_ist_epoch))
            hrs=$((remaining / 3600))
            mins=$(((remaining % 3600) / 60))
            echo "⏳ Not yet 18:30 IST — about ${hrs}h ${mins}m left. Cancelling workflow."
            exit 78
          else
            echo "✅ Target time reached, continuing..."
          fi

      # 📤 Send messages once target time reached
      - name: Send messages from list.txt
        if: success()
        env:
          BR: ${{ secrets.REAL }}
        run: |
          if [ ! -f list.txt ]; then
            echo "❌ list.txt not found!"
            exit 1
          fi

          while IFS= read -r username; do
            if [ -n "$username" ]; then
              echo "📨 Sending message to $username"
              python -u s.py "$username"
              echo "✅ Done for $username"
              echo "----------------------------------------"
              sleep 3
            fi
          done < list.txt

      # 🚫 Disable this workflow after run (safe version)
      - name: Disable this workflow after run
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH }}
        run: |
          echo "🔒 Disabling workflow '${{ github.workflow }}'..."
          workflow_file=$(basename "${{ github.workflow_ref }}" | cut -d'@' -f1)
          echo "🗂 Workflow file: $workflow_file"

          curl -s -X PUT \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$workflow_file/disable" \
            | tee response.json

          echo "✅ Workflow disable request sent."
          cat response.json
