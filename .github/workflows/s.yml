name: Send Lichess Messages from list.txt

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # ⏰ runs every hour at minute 0

jobs:
  send_messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      # 🕒 Time check step — stop if before 18:30 IST 29 Oct 2025
      - name: Check time (cancel if before target)
        id: timecheck
        run: |
          # Work in IST timezone
          export TZ='Asia/Kolkata'

          # Current IST timestamp
          current_ist_epoch=$(date '+%s')

          # Target time: 2025-10-29 18:30:00 IST
          target_ist_epoch=$(date -d '2025-10-29 18:30:00' '+%s')

          echo "🕒 Current IST: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "🎯 Target IST : 2025-10-29 18:30:00 IST"

          if [ "$current_ist_epoch" -lt "$target_ist_epoch" ]; then
            remaining=$((target_ist_epoch - current_ist_epoch))
            hrs=$((remaining / 3600))
            mins=$(((remaining % 3600) / 60))
            echo "⏳ Not yet 18:30 IST — about ${hrs}h ${mins}m left. Cancelling workflow."
            exit 78  # cancel job cleanly
          else
            echo "✅ Target time reached, continuing..."
          fi

      # 📤 Send messages once target time reached
      - name: Send messages from list.txt
        if: success()
        env:
          BR: ${{ secrets.REAL }}
        run: |
          if [ ! -f list.txt ]; then
            echo "❌ list.txt not found!"
            exit 1
          fi

          while IFS= read -r username; do
            if [ -n "$username" ]; then
              echo "📨 Sending message to $username"
              python -u s.py "$username"
              echo "✅ Done for $username"
              echo "----------------------------------------"
              sleep 3
            fi
          done < list.txt
